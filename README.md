# JFlash 设备补丁工具

这是一个用于向 SEGGER JFlash 添加自定义 MCU 设备补丁的图形化工具。它能够自动扫描补丁文件夹，合并 `JLinkDevices.xml` 文件，并复制设备算法文件夹到 JFlash 安装目录，确保自定义设备可在 JFlash 中正常使用。

## ✨ 功能特点

- **自动检测 JFlash 安装路径**：从环境变量、PATH 或常见安装目录中自动定位 JFlash。
- **智能设备文件夹选择**：自动识别补丁包中的设备文件夹（优先 `JLinkDevices`，其次 `Devices`，多选时自动选择第一个并记录日志）。
- **XML 合并去重**：将补丁中的设备定义合并到 JFlash 的 `JLinkDevices.xml`，自动去重并更新同名设备。
- **实时路径验证**：输入 JFlash 目录和 MCU 补丁根目录时实时检查有效性，并通过图标（✓/✗）和边框颜色反馈。
- **多补丁批量处理**：支持同时勾选多个 MCU 补丁，一键批量打补丁。
- **日志输出**：实时显示操作日志，进度条清晰展示处理进度。
- **权限检测**：开始操作前检查 JFlash 目录是否可写，若无权限则提示以管理员身份运行。

## 🖥️ 系统要求

- **操作系统**：Windows 7/8/10/11，Linux（需安装 X11 图形环境）
- **Python 版本**：3.6 或更高（仅源码运行时需要）
- **依赖库**：
  - PySide6（仅 GUI 版本需要）
  - Python 标准库（os, sys, shutil, xml.etree, pathlib 等）

## 📦 安装与运行

### 1. 从源码运行

#### 克隆或下载本项目

```bash
git clone https://github.com/USTHzhanglu/JFlashPatcher.git
cd jflashpatcher
```

#### 安装依赖（仅 GUI 需要）

```bash
pip install pyside6
```

#### 运行 GUI 版本

```bash
python jflash_patch_gui.py
```

### 2. 使用打包好的可执行文件（Windows）

下载发布页的zip文件,解压后直接双击exe运行即可，无需安装 Python。

## 🚀 使用说明

### GUI 版本

1. **JFlash 安装目录**  
   - 程序启动时会自动检测 JFlash 路径并填充。  
   - 可通过“浏览”按钮手动选择，路径有效性实时验证（绿色 ✓ 表示有效，红色 ✗ 表示无效）。  

2. **MCU 补丁根目录**  
   - 启动时会自动扫描预设候选路径（程序所在目录、上级 patchs 目录、当前工作目录等），找到第一个包含有效补丁的目录并填充。  
   - 可通过“浏览”按钮手动选择，目录下存在有效补丁（包含 `JLinkDevices.xml` 和子文件夹）时显示绿色 ✓，否则红色 ✗。  

3. **补丁列表**  
   - 扫描后，右侧列表显示所有有效 MCU 补丁，默认全部勾选。  
   - 可使用“全选”/“取消全选”按钮快速操作。  

4. **选项设置**  
   - 点击菜单栏“选项”可打开设置对话框，勾选“自动备份 JLinkDevices.xml”可在合并前自动创建备份（`.bak` 文件）。  

5. **开始打补丁**  
   - 当两个目录都验证通过（均为绿色 ✓）时，“开始打补丁”按钮启用。  
   - 点击后确认操作，程序将在后台处理，日志区域实时显示进度。  
   - 完成后弹出提示，需重启 JFlash 使设备列表生效。  


## ⚠️ 注意事项

- **管理员权限**：如果 JFlash 安装在系统保护目录（如 `C:\Program Files`），请**以管理员身份运行**程序，否则可能因权限不足导致写入失败。
- **XML 备份**：建议开启自动备份功能，以防合并出错时可快速恢复。
- **重启 JFlash**：补丁应用后，必须**重启 JFlash** 才能识别新增设备。
- **设备文件夹名称**：补丁包中的设备文件夹应命名为 `JLinkDevices` 或 `Devices`，否则程序会自动选择第一个子文件夹，并在日志中提示。

## ❓ 常见问题

**Q：为什么我的补丁文件夹没有被识别？**  
A：请确保文件夹内包含 `JLinkDevices.xml` 文件，并且至少有一个子文件夹（用于存放 FLM 算法文件）。

**Q：点击“开始打补丁”后，提示“权限不足”怎么办？**  
A：关闭程序，右键选择“以管理员身份运行”再试。

**Q：补丁列表为空，但目录下确实有补丁文件夹？**  
A：检查每个补丁文件夹是否符合要求（包含 `JLinkDevices.xml` 和至少一个子文件夹）。如果符合仍无法识别，请查看日志输出。

**Q：合并后 JFlash 仍然找不到设备？**  
A：确认 XML 中引用的 Loader 路径是否正确（通常应为 `JLinkDevices/厂商/型号/xxx.FLM`），且对应文件已复制到 JFlash 安装目录下的 `JLinkDevices` 文件夹内。

## 🙏 致谢

- 感谢 **DeepSeek** 提供 AI 辅助编码支持及主题设计。
- 作者：USTHzhanglu@outlook.com
- 版本：1.0.0

## 📄 许可证

本项目基于 MIT 许可证开源，详情请参阅 [LICENSE](LICENSE) 文件。
